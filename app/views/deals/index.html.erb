<h1>Listing deals</h1>

<table>
  <thead>
    <tr>
      <th>Deal</th>
      <th>Description</th>
      <th>Start time</th>
      <th>End time</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
    
   
    <script type="text/javascript">

    var initialLocation;
    var infos = [];
    var siberia = new google.maps.LatLng(60, 105);
    var newyork = new google.maps.LatLng(40.69847032728747, -73.9514422416687);
    var browserSupportFlag =  new Boolean();
    var allMyDeals = <%= @some_deals %>;


    function initialize() {
      var myOptions = {
        zoom: 14,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      };
      var map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);
      var image = '/assets/smiley_happy.png'; 

      // Try W3C Geolocation (Preferred)
      if(navigator.geolocation) {
        browserSupportFlag = true;
        navigator.geolocation.getCurrentPosition(function(position) {
          initialLocation = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
          var Person_marker = new google.maps.Marker({
            position: initialLocation,
            title:"Where I am!",
            map: map,
            animation: google.maps.Animation.DROP,
            icon: image
          });      
              
          map.setCenter(initialLocation);
        }, function() {
          handleNoGeolocation(browserSupportFlag);
        });
      }
      // Browser doesn't support Geolocation
      else {
        browserSupportFlag = false;
        handleNoGeolocation(browserSupportFlag);
      }

      function handleNoGeolocation(errorFlag) {
        if (errorFlag == true) {
          alert("Geolocation service failed.");
          initialLocation = newyork;
        } else {
          alert("Your browser doesn't support geolocation. We've placed you in Siberia.");
          initialLocation = siberia;
        }
        map.setCenter(initialLocation);
      }

    //drop the pins consecutively - later

    // function drop() {
    //   for (var i = 0; i < allMyDeals.length; i++) {
    //     setTimeout(function() {
    //       addMarker();
    //       }, i * 200);
    //     }
    //   }

      // var descriptions = [];
      // var dealMarkers = [];
        for(var i=0; i < allMyDeals.length; i++){
          var num = i+1;
          var location = new google.maps.LatLng(allMyDeals[i].latitude, allMyDeals[i].longitude);
          var dealMarker = new google.maps.Marker({
            position: location,
            map: map,
            animation: google.maps.Animation.DROP,
            icon: '/assets/number_' + num + '.png',
            title: allMyDeals[i].deal,
            content: allMyDeals[i].description
          });

          function closeInfos(){
            if(infos.length > 0){
              // detach the info-window from the marker 
              infos[0].set("dealMarker", null);

               // and close it 
              infos[0].close();

               // blank the array 
              infos.length = 0;
              }
            }
           
          google.maps.event.addListener(dealMarker, 'click', function() {
         
             // close the previous info-window 
            closeInfos();

             // the marker's content gets attached to the info-window: 
            var info = new google.maps.InfoWindow({content: this.content});

             // trigger the infobox's open function 
            info.open(map,this);

             // keep the handle, in order to close it on next click event 
            infos[0]=info;
         
          });
        }
      }

    $(function() {
      initialize();

    })
    </script>
  </thead>

  <tbody>
    <% Deal.find(:all, :order => "id desc", :limit => 3).each do |deal|  %>
   
      <tr>
        <td><%= deal.deal %></td>
        <td><%= deal.description %></td>
        <!-- <td><%= deal.start_time %></td>
        <td><%= deal.end_time %></td> -->
        <td><%= link_to 'Show', deal %></td>
        <td><%= link_to 'Edit', edit_deal_path(deal) %></td>
        <td><%= link_to 'Destroy', deal, method: :delete, data: { confirm: 'Are you sure?' } %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<br>

<%= link_to 'New Deal', new_deal_path %>

